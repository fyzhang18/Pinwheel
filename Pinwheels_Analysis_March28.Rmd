---
title: "Untitled"
author: "Felicia Zhang"
date: '2018-01-24'
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2) 
library(zoo)
library(reshape)
library(plyr)
library(dplyr)
library(scales) 
library(data.table)
library(signal)
library(matrixStats)
library(lme4)
library(arm)
library(RColorBrewer)
library(lmerTest)
library(boot)

#load preprocessed data
orig.sample2 <- read.csv("/Volumes/emberson/ResearchProjects/Pupillometry/Pinwheels/Data/Pinwheel_Infant_Preprocessed_RemovedOutliers_Nov28.csv")  #Nov28 has bad trials removed
orig.sample2$X <- NULL
orig.sample2$X.1 <- NULL

#recode trial number
orig.sample2$trialnum <- 0
orig.sample2$trialnum[orig.sample2$TRIAL_INDEX == 1 | orig.sample2$TRIAL_INDEX == 9 | orig.sample2$TRIAL_INDEX == 17 | orig.sample2$TRIAL_INDEX == 25 | orig.sample2$TRIAL_INDEX == 33 | orig.sample2$TRIAL_INDEX == 41] <- 1
orig.sample2$trialnum[orig.sample2$TRIAL_INDEX == 2 | orig.sample2$TRIAL_INDEX == 10 | orig.sample2$TRIAL_INDEX == 18 | orig.sample2$TRIAL_INDEX == 26 | orig.sample2$TRIAL_INDEX == 34 | orig.sample2$TRIAL_INDEX == 42] <- 2
orig.sample2$trialnum[orig.sample2$TRIAL_INDEX == 3 | orig.sample2$TRIAL_INDEX == 11 | orig.sample2$TRIAL_INDEX == 19 | orig.sample2$TRIAL_INDEX == 27 | orig.sample2$TRIAL_INDEX == 35 | orig.sample2$TRIAL_INDEX == 43] <- 3
orig.sample2$trialnum[orig.sample2$TRIAL_INDEX == 4 | orig.sample2$TRIAL_INDEX == 12 | orig.sample2$TRIAL_INDEX == 20 | orig.sample2$TRIAL_INDEX == 28 | orig.sample2$TRIAL_INDEX == 36 | orig.sample2$TRIAL_INDEX == 44] <- 4
orig.sample2$trialnum[orig.sample2$TRIAL_INDEX == 5 | orig.sample2$TRIAL_INDEX == 13 | orig.sample2$TRIAL_INDEX == 21 | orig.sample2$TRIAL_INDEX == 29 | orig.sample2$TRIAL_INDEX == 37 | orig.sample2$TRIAL_INDEX == 45] <- 5
orig.sample2$trialnum[orig.sample2$TRIAL_INDEX == 6 | orig.sample2$TRIAL_INDEX == 14 | orig.sample2$TRIAL_INDEX == 22 | orig.sample2$TRIAL_INDEX == 30 | orig.sample2$TRIAL_INDEX == 38 | orig.sample2$TRIAL_INDEX == 46] <- 6
orig.sample2$trialnum[orig.sample2$TRIAL_INDEX == 7 | orig.sample2$TRIAL_INDEX == 15 | orig.sample2$TRIAL_INDEX == 23 | orig.sample2$TRIAL_INDEX == 31 | orig.sample2$TRIAL_INDEX == 39 | orig.sample2$TRIAL_INDEX == 47] <- 7
orig.sample2$trialnum[orig.sample2$TRIAL_INDEX == 8 | orig.sample2$TRIAL_INDEX == 16 | orig.sample2$TRIAL_INDEX == 24 | orig.sample2$TRIAL_INDEX == 32 | orig.sample2$TRIAL_INDEX == 40 | orig.sample2$TRIAL_INDEX == 48] <- 8

#excluded trial 1 of each preswitch sub-block
orig.sample3 <- subset(orig.sample2, !(switch==1 & trialnum==1))

#counting number of babies for criteria 3: contribute at least one trial for 4/6 subblock (2 for preswitch and 2 for postswitch)
#exclude: 3, 4, 16, 19, 22, 27, 29, 30 (8 subs excluded)
orig.sample4 <- subset(orig.sample3, subID != 3)
orig.sample4 <- subset(orig.sample4, subID != 4)
orig.sample4 <- subset(orig.sample4, subID != 16)
orig.sample4 <- subset(orig.sample4, subID != 19)
orig.sample4 <- subset(orig.sample4, subID != 22)
orig.sample4 <- subset(orig.sample4, subID != 27)
orig.sample4 <- subset(orig.sample4, subID != 29)
orig.sample4 <- subset(orig.sample4, subID != 30)

#orig.sample2 = trials with more than 50% looking
#orig.sample3 = excluded trial 1 of each preswitch sub-block
#orig.sample4 = excluded subjects
```

AEM coding
```{r}
poo <- orig.sample4

#1. Binning every 100ms, to make sure that it's actually a fixation for lookstotarget
moo <- data.frame(subID=numeric(),trialnum=numeric(),timecode=numeric(),block=numeric(),switch=numeric(),lookingattarget=numeric())
subs <- unique(poo$subID)
time <- seq(100,4000, by=100) #the time bins we are trying to create (0-4000ms) doing 4000ms 

for (j in 1:length(subs)) {
  #gets every trial for 1 subject
  trials <- unique(poo$TRIAL_INDEX[poo$subID==subs[j]])
  print(j)
  for (i in 1:length(trials)) {
    #gets all sample for 1 trial  
    woo <- subset(poo, subID==subs[j] & TRIAL_INDEX == trials[i])
    c <- woo$block[1]
    cc <- woo$switch[1]
    ccc <- woo$trialnum[1]
    for (k in 1:length(time)){
      #for every 25 sample/100 ms, get lookattarget column
      if (k==1) {
        target <- woo$lookattarget[woo$TIMECODE < time[k]+1] #gets 0-100ms
        d <- unique(target)
        dd <- which(d==1)
      } else {
        target <- woo$lookattarget[woo$TIMECODE < time[k]+1 & woo$TIMECODE > time[k-1]-1]
        d <- unique(target)
        dd <- which(d==1)
      }
      #see if entire chunk is looking at target
      if (length(target)==0) { #no samples collected during this time
        aa <- c(subs[j],trials[i],ccc,c,cc,time[k],99)   
        moo <- rbind(moo,aa)
        warnings()
      } else if (length(d)==1 & d==1) { #looking at target entire time
        aa <- c(subs[j],trials[i],ccc,c,cc,time[k],d)   
        moo <- rbind(moo,aa)
        warnings()
      } else if (length(d)==1 & d==0) { #looking at distractor entire time
        aa <- c(subs[j],trials[i],ccc,c,cc,time[k],d)   
        moo <- rbind(moo,aa)
        warnings()
      } else if (length(d)==1 & d==5) { #looking at center entire time
        aa <- c(subs[j],trials[i],ccc,c,cc,time[k],d)   
        moo <- rbind(moo,aa)
        warnings()
      } else if (length(d) > 1 & length(dd) < 1) { #not looking at same location and not looking at target (looking at distractor and center)
        aa <- c(subs[j],trials[i],ccc,c,cc,time[k],9)   
        moo <- rbind(moo,aa) 
        warnings()
      } else { #not looking at same location and but looking at target sometimes
        #calculate proportion looking  
        b <- length(which(target==1)) #samples where subs are looking at target
        bb <- length(which(target==1))/length(target) #looking at target/25
        aa <- c(subs[j],trials[i],ccc,c,cc,time[k],bb) 
        moo <- rbind(moo,aa)
        warnings()
      }}}}

names(moo)[1] <- "subID"
names(moo)[2] <- "trialnum"
names(moo)[3] <- "trialnum2"
names(moo)[4] <- "block"
names(moo)[5] <- "switch"
names(moo)[6] <- "timecode"
names(moo)[7] <- "lookattarget"

#0 = distractor, 1 = target, 5 = center, 9 = looking at distractor and center, 99 = no data collected
x1 <- subset(moo, lookattarget < 99) #remove no data collected
x1$looktocenter <- 0

#coding which trials looked to center before making AEM
subs <- unique(x1$subID)
for (j in 1:length(subs)) {
  #gets every trial for 1 subject
  trials <- unique(x1$trialnum[x1$subID==subs[j]])
  print(j)
  for (i in 1:length(trials)) {
    foo <- subset(x1, subID==subs[j] & trialnum==trials[i] & timecode < 701)  
    if (any(foo$lookattarget==5)) {
      x1$looktocenter[x1$subID==subs[j] & x1$trialnum==trials[i]] <- 1
    }
  }}

#code trial type: pupil match, pupil mismatch, or no AEM 
#must look to center first, must make eye movement in 700-2700ms
#type 1 = pupil match, 2 = pupil mismatch, 3 = no AEM

x1$type <- 3
subs <- unique(x1$subID)

for (j in 1:length(subs)) {
  #gets every trial for 1 subject
  trials <- unique(x1$trialnum[x1$subID==subs[j]])
  print(j)
  for (i in 1:length(trials)) {
    #current trial
    foo <- subset(x1, subID==subs[j] & trialnum==trials[i] & timecode > 699 & timecode <2601) 
    if (any(foo$lookattarget==0) & foo$looktocenter[1]==1) {
      x1$type[x1$subID==subs[j] & x1$trialnum==trials[i]] <- 2
    }
    if (any(foo$lookattarget==1) & foo$looktocenter[1]==1) {
      x1$type[x1$subID==subs[j] & x1$trialnum==trials[i]] <- 1
    }
    }
  }

pupilbreakdown <- x1
```

add in trialtype info for orig.sample4
Recode every trial two times
- correct vs incorrect for AEM
-match vs mismatch for the pupil 

```{r}
#match vs mismatch for the pupil 
z1 <- ddply(pupilbreakdown,.(subID,trialnum,trialnum2),summarise,trialtype=(unique(type,na.rm = TRUE)))  
z1 <- subset(z1, trialtype < 3)

orig.sample4$trialtype.pupil <- 3

for (j in 1:length(z1$subID)) {
  x <- z1$subID[j]
  y <- z1$trialnum[j]
  y2 <- z1$trialnum2[j]
  z <- z1$trialtype[j]
  orig.sample4$trialtype.pupil[orig.sample4$subID==x & orig.sample4$TRIAL_INDEX==y & orig.sample4$trialnum==y2] <- z
}
#type 1 = pupil match, 2 = pupil mismatch, 3 = no AEM

#correct vs incorrect for AEM
orig.sample4$trialtype.aem <- orig.sample4$trialtype.pupil
#only trial 1 of post-switch switches labelling, unless it's 3
orig.sample4$trialtype.aem[orig.sample4$trialtype.pupil==1 & orig.sample4$trialnum==1 & orig.sample4$switch==2] <- 2
orig.sample4$trialtype.aem[orig.sample4$trialtype.pupil==2 & orig.sample4$trialnum==1 & orig.sample4$switch==2] <- 1
#type 1 = correct aem, 2 = incorrect aem, 3 = no AEM

#checking to make sure the correct trials were recoded
foo <- ddply(orig.sample4,.(subID,TRIAL_INDEX,trialtype.aem),summarise,trialtype.pupil=unique(trialtype.pupil,na.rm = TRUE))
foo$diff <- foo$trialtype.aem - foo$trialtype.pupil 
```

Recode post-switch trial 1
```{r}
orig.sample4a <- subset(orig.sample4, switch==1)
orig.sample4a <- subset(orig.sample4a, trialnum > 1)
orig.sample4a$NEWTRIALNUM <- orig.sample4a$trialnum
#2-9 for pre, 1-8 for post

orig.sample4b <- subset(orig.sample4, switch==2)
orig.sample4b$NEWTRIALNUM <- orig.sample4b$trialnum 

#relabel center and aem time period as preswitch trial 9
orig.sample4b$switch[orig.sample4b$TIMECODE < 2701 & orig.sample4b$trialnum==1] <- 1
orig.sample4b$NEWTRIALNUM[orig.sample4b$TIMECODE < 2701 & orig.sample4b$trialnum==1] <- 9

orig.sample5 <- rbind(orig.sample4a,orig.sample4b)

orig.sample5$TRIAL_INDEX[orig.sample5$switch==1 & orig.sample5$NEWTRIALNUM==9 & orig.sample5$block==1] <- 101
orig.sample5$TRIAL_INDEX[orig.sample5$switch==1 & orig.sample5$NEWTRIALNUM==9 & orig.sample5$block==2] <- 201
orig.sample5$TRIAL_INDEX[orig.sample5$switch==1 & orig.sample5$NEWTRIALNUM==9 & orig.sample5$block==3] <- 301
```

categorize babies based on % AEM , do median split 
```{r}
#categorize babies based on % AEM , do median split 
z1 <- ddply(orig.sample5,.(subID,TRIAL_INDEX),summarise,aemtrialtype=unique(trialtype.aem,na.rm = TRUE))  
#total number of trials
z3 <- ddply(z1,.(subID),summarise,trialnum=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#aem trials, only want correct and incorrect
#type 1 = correct AEM to target, 2 = incorrect AEM to distractor, 3 = no AEM
z2 <- subset(z1, aemtrialtype < 3) 
#total number of AEM (correct and incorrect)  
z4 <- ddply(z2,.(subID),summarise,trialnum=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#calculate percent AEM (# of AEM/# of trials)
z3$percentaem <- 0
subs <- unique(z3$subID)
for (j in 1:length(subs)) { 
z <- which(z4$subID==subs[j])
if (length(z)==0) { #if doesn't match
  z3$percentaem[j] <- NA
} else {
  z3$percentaem[j] <-z4$trialnum[z] / z3$trialnum[j]
}} 

#calculate median split
aem.med <- median(z3$percentaem, na.rm = TRUE)
which(z3$percentaem < aem.med) #2  3  7  9 11 14 20 21 22 24 25 26
which(z3$percentaem > aem.med) #1  4  5  8 10 12 13 15 16 18 19 23
orig.sample5$median.aem <- 1 #below median

#label in dataframe  
orig.sample5$median.aem[orig.sample5$subID==subs[1] | orig.sample5$subID==subs[4] | orig.sample5$subID==subs[5] | orig.sample5$subID==subs[8] |orig.sample5$subID==subs[10]| orig.sample5$subID==subs[12]| orig.sample5$subID==subs[13]|  orig.sample5$subID==subs[15]| orig.sample5$subID==subs[16]| orig.sample5$subID==subs[18]| orig.sample5$subID==subs[19]| orig.sample5$subID==subs[23]] <- 2
```

bar graph: pupil match/mismatch percentage for each subject
```{r}
#total number of trials completed by subject
w1 <- ddply(orig.sample5,.(subID,TRIAL_INDEX),summarise,pupiltrialtype=unique(trialtype.pupil,na.rm = TRUE))
w2 <- ddply(w1,.(subID),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#grouping trials into trialtypes
w.match <- subset(w1, pupiltrialtype==1)
w.mismatch <- subset(w1, pupiltrialtype==2)
w.no <- subset(w1, pupiltrialtype==3)

#total number of trials for each trial type  
w.match2 <- ddply(w.match,.(subID),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
w.mismatch2 <- ddply(w.mismatch,.(subID),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
w.no2 <- ddply(w.no,.(subID),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#create empty dataframe
subs <- unique(orig.sample5$subID)
goo <- data.frame(subID=numeric(78),trialtype=numeric(78),percent=numeric(78))
goo$subID <- subs
goo$trialtype <- rep(1:3, each = 26)

#calculate percent
#trialtype 1 (match)
subs <- unique(goo$subID)
for (j in 1:length(subs)) { 
z <- which(w.match2$subID==subs[j])
zz <- which(w2$subID==subs[j]) 
if (length(z)==0) { #if doesn't match
  goo$percent[j] <- NA
} else {
  goo$percent[j] <- w.match2$numoftrials[z] / w2$numoftrials[zz]
}} 

#trialtype 2 (mismatch)
subs <- unique(goo$subID)
for (j in 1:length(subs)) { 
z <- which(w.mismatch2$subID==subs[j])
zz <- which(w2$subID==subs[j]) 
if (length(z)==0) { #if doesn't match
  goo$percent[j+26] <- NA
} else {
  goo$percent[j+26] <- w.mismatch2$numoftrials[z] / w2$numoftrials[zz]
}} 

#trialtype 3 (no AEM)
subs <- unique(goo$subID)
for (j in 1:length(subs)) { 
z <- which(w.no2$subID==subs[j])
zz <- which(w2$subID==subs[j]) 
if (length(z)==0) { #if doesn't match
  goo$percent[j+52] <- NA
} else {
  goo$percent[j+52] <- w.no2$numoftrials[z] / w2$numoftrials[zz]
}} 

#plot
goo$trialtype[1:26] <- 3
goo$trialtype[53:78] <- 1
  
ggplot(goo,aes(x=factor(subID),y=percent,color=factor(trialtype),fill=factor(trialtype)))+
  geom_bar(stat="identity")+
  labs(x = "Subject", y = "% of trials")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  guides(color=FALSE)+
  scale_color_manual(values = c("#f1af8f", "#2398a0","#acc2c7"))+
  scale_fill_manual(values = c("#f1af8f", "#2398a0","#acc2c7"),name="Trial breakdown",breaks=c("1","2","3"),labels=c("no AEM", "pupil mismatch","pupil match"))+
  theme(legend.position = "bottom")+
  theme(panel.background = element_rect(fill = "#f5ebe1",colour = "#f5ebe1",size = 0.5, linetype = "solid"))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
```

bar graph: aem correct/incorrect percentage for each subject
```{r}
#total number of trials completed by subject
v1 <- ddply(orig.sample5,.(subID,TRIAL_INDEX),summarise,aemtrialtype=unique(trialtype.aem,na.rm = TRUE))
v2 <- ddply(v1,.(subID),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#grouping trials into trialtypes
v.cor <- subset(v1, aemtrialtype==1)
v.incor <- subset(v1, aemtrialtype==2)
v.no <- subset(v1, aemtrialtype==3)

#total number of trials for each trial type  
v.cor2 <- ddply(v.cor,.(subID),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
v.incor2 <- ddply(v.incor,.(subID),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
v.no2 <- ddply(v.no,.(subID),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#create empty dataframe
subs <- unique(orig.sample5$subID)
moo <- data.frame(subID=numeric(78),trialtype=numeric(78),percent=numeric(78))
moo$subID <- subs
moo$trialtype <- rep(1:3, each = 26)

#calculate percent
#trialtype 1 (correct)
subs <- unique(moo$subID)
for (j in 1:length(subs)) { 
z <- which(v.cor2$subID==subs[j])
zz <- which(v2$subID==subs[j]) 
if (length(z)==0) { #if doesn't match
  moo$percent[j] <- NA
} else {
  moo$percent[j] <- v.cor2$numoftrials[z] / v2$numoftrials[zz]
}} 

#trialtype 2 (incorrect)
subs <- unique(moo$subID)
for (j in 1:length(subs)) { 
z <- which(v.incor2$subID==subs[j])
zz <- which(v2$subID==subs[j]) 
if (length(z)==0) { #if doesn't match
  moo$percent[j+26] <- NA
} else {
  moo$percent[j+26] <- v.incor2$numoftrials[z] / v2$numoftrials[zz]
}} 

#trialtype 3 (no AEM)
subs <- unique(moo$subID)
for (j in 1:length(subs)) { 
z <- which(v.no2$subID==subs[j])
zz <- which(v2$subID==subs[j]) 
if (length(z)==0) { #if doesn't match
  moo$percent[j+52] <- NA
} else {
  moo$percent[j+52] <- v.no2$numoftrials[z] / v2$numoftrials[zz]
}} 

#plot
moo$trialtype[1:26] <- 3
moo$trialtype[53:78] <- 1
  
ggplot(moo,aes(x=factor(subID),y=percent,color=factor(trialtype),fill=factor(trialtype)))+
  geom_bar(stat="identity")+
  labs(x = "Subject", y = "% of trials")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  guides(color=FALSE)+
  scale_fill_brewer(palette="Set3",name="Trial breakdown",breaks=c("1","2","3"),labels=c("no AEM", "incorrect AEMs","correct AEMs"))+
  scale_color_brewer(palette="Set3")+
  theme(legend.position = "bottom")+
  scale_y_continuous(label=percent,limits=c(0,1),breaks=seq(0,1,.2))

```

Correlation to see if correct AEM is related to pupil difference
x axis = % of correct AEMs for each baby and each block (correct AEM / total num of trials)
y axis = subtraction of preswitch and postswitch pupil of 1500-2000ms, for each block
```{r}
#x axis (calculate percent of correct aem)
u1 <- ddply(orig.sample5,.(subID,switch,block,TRIAL_INDEX),summarise,aemtrialtype=unique(trialtype.aem,na.rm = TRUE))
u2 <- ddply(u1,.(subID,block),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#grouping trials into trialtypes
u3 <- subset(u1, aemtrialtype==1)
u4 <- ddply(u3,.(subID,block),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#calculate percent
u2$percentcorrect <- 0
for (j in 1:length(u2$subID)) { 
x <- u2$subID[j]  
x2 <- u2$block[j]
z <- which(u4$subID==x & u4$block==x2)
if (length(z)==0) { #if doesn't match
  u2$percentcorrect[j] <- 0
} else {
  u2$percentcorrect[j] <-u4$numoftrials[z] / u2$numoftrials[j]
}} 

#y axis (pupil for 1500-2000ms)
poo <- subset(orig.sample5, TIMECODE >1499 & TIMECODE < 2001)
y1 <- ddply(poo,.(subID,switch,block),summarise,pupilsize=mean(PUPIL_CORRECTED,na.rm = TRUE))
y1.pre <- subset(y1, switch==1)
y1.post <- subset(y1, switch==2)

yfinal <- data.frame(subID=numeric(78),block=numeric(78),pupildiff=numeric(78))
subs <- unique(orig.sample5$subID)
yfinal$subID <- subs
yfinal$block <- rep(1:3, each = 26)

for (j in 1:length(yfinal$subID)) { 
x <- yfinal$subID[j]  
x2 <- yfinal$block[j]
z <- which(y1.pre$subID==x & y1.pre$block==x2)
z2 <- which(y1.post$subID==x & y1.post$block==x2)
if (length(z)==0 | length(z2)==0) { #if doesn't match
  yfinal$pupildiff[j] <- NA
} else {
  yfinal$pupildiff[j] <- y1.post$pupilsize[z2] - y1.pre$pupilsize[z]
}} 

#combine pupil difference and aem
yfinal$percentcorrect <- 0
for (j in 1:length(yfinal$subID)) { 
x <- yfinal$subID[j]  
x2 <- yfinal$block[j]
z <- which(u2$subID==x & u2$block==x2)
if (length(z)==0) { #if doesn't match
  yfinal$percentcorrect[j] <- NA
} else {
  yfinal$percentcorrect[j] <- u2$percentcorrect[z]
}} 

ggplot(yfinal,aes(x=percentcorrect,y=pupildiff,fill=factor(block),color=factor(block)))+
  geom_point(size=5)+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  labs(x = "% of correct AEMs (correct AEM/num of trials)", y = "pupil difference bw 1500-2000ms (post-pre)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  guides(fill=FALSE)+
  stat_smooth(method=lm)+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "bottom")+
  scale_color_discrete(name = "Block")

cor.test(yfinal$pupildiff[yfinal$block==1], yfinal$percentcorrect[yfinal$block==1], alternative = "two.sided", method = "pearson")
cor.test(yfinal$pupildiff[yfinal$block==2], yfinal$percentcorrect[yfinal$block==2], alternative = "two.sided", method = "pearson")
cor.test(yfinal$pupildiff[yfinal$block==3], yfinal$percentcorrect[yfinal$block==3], alternative = "two.sided", method = "pearson")

#remove 0%
yfinal2 <- subset(yfinal, percentcorrect > 0)
ggplot(yfinal2,aes(x=percentcorrect,y=pupildiff,fill=factor(block),color=factor(block)))+
  geom_point(size=5)+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  labs(x = "% of correct AEMs (correct AEM/num of trials)", y = "pupil difference bw 1500-2000ms (post-pre)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  guides(fill=FALSE)+
  stat_smooth(method=lm)+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "bottom")+
  scale_color_discrete(name = "Block")

cor.test(yfinal2$pupildiff[yfinal2$block==1], yfinal2$percentcorrect[yfinal2$block==1], alternative = "two.sided", method = "pearson")
cor.test(yfinal2$pupildiff[yfinal2$block==2], yfinal2$percentcorrect[yfinal2$block==2], alternative = "two.sided", method = "pearson")
cor.test(yfinal2$pupildiff[yfinal2$block==3], yfinal2$percentcorrect[yfinal2$block==3], alternative = "two.sided", method = "pearson")
```

Correlation to see if correct AEM is related to pupil difference
x axis = % of correct AEMs for each baby and each block (correct AEM / total num of trials)
y axis = subtraction between the pupil of 2500-4000
```{r}
#x axis (calculate percent of correct aem)
u1 <- ddply(orig.sample5,.(subID,switch,block,TRIAL_INDEX),summarise,aemtrialtype=unique(trialtype.aem,na.rm = TRUE))
u2 <- ddply(u1,.(subID,block),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#grouping trials into trialtypes
u3 <- subset(u1, aemtrialtype==1)
u4 <- ddply(u3,.(subID,block),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#calculate percent
u2$percentcorrect <- 0
for (j in 1:length(u2$subID)) { 
x <- u2$subID[j]  
x2 <- u2$block[j]
z <- which(u4$subID==x & u4$block==x2)
if (length(z)==0) { #if doesn't match
  u2$percentcorrect[j] <- 0
} else {
  u2$percentcorrect[j] <-u4$numoftrials[z] / u2$numoftrials[j]
}} 

#y axis (pupil for 2500-4000ms)
poo <- subset(orig.sample5, TIMECODE >2499 & TIMECODE < 4001)
y1 <- ddply(poo,.(subID,switch,block),summarise,pupilsize=mean(PUPIL_CORRECTED,na.rm = TRUE))
y1.pre <- subset(y1, switch==1)
y1.post <- subset(y1, switch==2)

yfinal <- data.frame(subID=numeric(78),block=numeric(78),pupildiff=numeric(78))
subs <- unique(orig.sample5$subID)
yfinal$subID <- subs
yfinal$block <- rep(1:3, each = 26)

for (j in 1:length(yfinal$subID)) { 
x <- yfinal$subID[j]  
x2 <- yfinal$block[j]
z <- which(y1.pre$subID==x & y1.pre$block==x2)
z2 <- which(y1.post$subID==x & y1.post$block==x2)
if (length(z)==0 | length(z2)==0) { #if doesn't match
  yfinal$pupildiff[j] <- NA
} else {
  yfinal$pupildiff[j] <- y1.post$pupilsize[z2] - y1.pre$pupilsize[z]
}} 

#combine pupil difference and aem
yfinal$percentcorrect <- 0
for (j in 1:length(yfinal$subID)) { 
x <- yfinal$subID[j]  
x2 <- yfinal$block[j]
z <- which(u2$subID==x & u2$block==x2)
if (length(z)==0) { #if doesn't match
  yfinal$percentcorrect[j] <- NA
} else {
  yfinal$percentcorrect[j] <- u2$percentcorrect[z]
}} 

#plot
ggplot(yfinal,aes(x=percentcorrect,y=pupildiff,fill=factor(block),color=factor(block)))+
  geom_point(size=5)+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  labs(x = "% of correct AEMs (correct AEM/num of trials)", y = "pupil difference bw 2500-4000ms (post-pre)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  guides(fill=FALSE)+
  stat_smooth(method=lm)+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "bottom")+
  scale_color_discrete(name = "Block")

cor.test(yfinal$pupildiff[yfinal$block==1], yfinal$percentcorrect[yfinal$block==1], alternative = "two.sided", method = "pearson")
cor.test(yfinal$pupildiff[yfinal$block==2], yfinal$percentcorrect[yfinal$block==2], alternative = "two.sided", method = "pearson")
cor.test(yfinal$pupildiff[yfinal$block==3], yfinal$percentcorrect[yfinal$block==3], alternative = "two.sided", method = "pearson")

#remove 0%
yfinal2 <- subset(yfinal, percentcorrect > 0)
ggplot(yfinal2,aes(x=percentcorrect,y=pupildiff,fill=factor(block),color=factor(block)))+
  geom_point(size=5)+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  labs(x = "% of correct AEMs (correct AEM/num of trials)", y = "pupil difference bw 2500-4000ms (post-pre)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  guides(fill=FALSE)+
  stat_smooth(method=lm)+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "bottom")+
  scale_color_discrete(name = "Block")

cor.test(yfinal2$pupildiff[yfinal2$block==1], yfinal2$percentcorrect[yfinal2$block==1], alternative = "two.sided", method = "pearson")
cor.test(yfinal2$pupildiff[yfinal2$block==2], yfinal2$percentcorrect[yfinal2$block==2], alternative = "two.sided", method = "pearson")
cor.test(yfinal2$pupildiff[yfinal2$block==3], yfinal2$percentcorrect[yfinal2$block==3], alternative = "two.sided", method = "pearson")

```

How well u do in preswitch (% correct AEM in preswitch) -> postswitch (% correct AEM in postswitch) correlation for every subject 
(correct AEM / total num of trials)
```{r}
#x axis (calculate percent of correct aem)
u1 <- ddply(orig.sample5,.(subID,switch,TRIAL_INDEX),summarise,aemtrialtype=unique(trialtype.aem,na.rm = TRUE))
u1.pre <- subset(u1, aemtrialtype==1 & switch==1)
u1.post <- subset(u1, aemtrialtype==1 & switch==2)

#num of correct aem for every subject
u2.pre <- ddply(u1.pre,.(subID,switch),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
u2.post <- ddply(u1.post,.(subID,switch),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#number of trials for every subject
u3a <- subset(u1, switch==1)
u3b <- subset(u1, switch==2)
u3.pre <- ddply(u3a,.(subID,switch),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
u3.post <- ddply(u3b,.(subID,switch),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))

#calculate percent for preswitch
u3.pre$percentcorrect <- 0
for (j in 1:length(u3.pre$subID)) { 
x <- u3.pre$subID[j]  
z <- which(u2.pre$subID==x)
if (length(z)==0) { #if doesn't match
  u3.pre$percentcorrect[j] <- 0
} else {
  u3.pre$percentcorrect[j] <-u2.pre$numoftrials[z] / u3.pre$numoftrials[j]
}} 

#calculate percent for postswtich
u3.post$percentcorrect <- 0
for (j in 1:length(u3.post$subID)) { 
x <- u3.post$subID[j]  
z <- which(u2.post$subID==x)
if (length(z)==0) { #if doesn't match
  u3.post$percentcorrect[j] <- 0
} else {
  u3.post$percentcorrect[j] <-u2.post$numoftrials[z] / u3.post$numoftrials[j]
}} 

ufinal <- u3.pre
names(ufinal)[4] <- "percentcorrect.pre"
ufinal$percentcorrect.post <- u3.post$percentcorrect

#plot
ggplot(ufinal,aes(x=percentcorrect.pre,y=percentcorrect.post))+
  geom_count(show.legend=F)+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  labs(x = "% of correct AEMs preswitch (correct AEM/num of trials)", y = "% of correct AEMs postswitch (correct AEM/num of trials)")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  guides(fill=FALSE)+
  stat_smooth(method=lm)+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "bottom")+
  scale_color_discrete(name = "Block")

cor.test(ufinal$percentcorrect.pre, ufinal$percentcorrect.post, alternative = "two.sided", method = "pearson")

#remove 0%
ufinal2 <- subset(ufinal, !(percentcorrect.pre==0 & percentcorrect.post==0))
ggplot(ufinal2,aes(x=percentcorrect.pre,y=percentcorrect.post))+
  geom_count(show.legend=F)+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  labs(x = "% of correct AEMs preswitch (correct AEM/num of trials)", y = "% of correct AEMs postswitch (correct AEM/num of trials)")+
  theme(plot.title = element_text(face="bold", size=14, hjust=0))+
  theme(axis.title = element_text(face="bold", size=14))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  guides(fill=FALSE)+
  stat_smooth(method=lm)+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "bottom")+
  scale_color_discrete(name = "Block")

cor.test(ufinal2$percentcorrect.pre, ufinal2$percentcorrect.post, alternative = "two.sided", method = "pearson")

```

pupil timecourse for 3 trial types (pupil match, pupil mismatch, no AEM)
```{r}
#separate for all 3 trial types
boo1 <- ddply(orig.sample5,.(subID,trialtype.pupil,TIMECODE),summarise,pupil=mean(PUPIL_CORRECTED,na.rm = TRUE)) #collapse across trials
boo1 <- subset(boo1, TIMECODE < 4001)
boo2 <- ddply(boo1,.(trialtype.pupil,TIMECODE),summarise,pupilavg=mean(pupil,na.rm = TRUE),sepupil=sd(pupil, na.rm = TRUE)/sqrt(length(pupil))) #collapse across subs
vlines <- c(250,1750,2550)

#type 1 = pupil match, 2 = pupil mismatch, 3 = no AEM
ggplot(boo2,aes(x=TIMECODE,y=pupilavg,color=factor(trialtype.pupil),fill=factor(trialtype.pupil)))+
  geom_line()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Timecourse: Pupil Change")+
  labs(x = "Time", y = "Pupil change from baseline (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  geom_ribbon(aes(ymin=pupilavg-sepupil,ymax=pupilavg+sepupil),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  guides(color=FALSE)+
  scale_color_manual(values = c("#f1af8f", "#2398a0","#acc2c7"))+
  scale_fill_manual(values = c("#f1af8f", "#2398a0","#acc2c7"),name="Trial breakdown",breaks=c("1","2","3"),labels=c("pupil match", "pupil mismatch","no AEM"))+
  theme(legend.position = "bottom")

#pre vs post
boo1 <- ddply(orig.sample5,.(subID,switch,trialtype.pupil,TIMECODE),summarise,pupil=mean(PUPIL_CORRECTED,na.rm = TRUE)) #collapse across trials
boo1 <- subset(boo1, TIMECODE < 4001)
boo2 <- ddply(boo1,.(switch,trialtype.pupil,TIMECODE),summarise,pupilavg=mean(pupil,na.rm = TRUE),sepupil=sd(pupil, na.rm = TRUE)/sqrt(length(pupil))) #collapse across subs
vlines <- c(250,1750,2550)
split <- c(`1` = "preswitch",`2` = "postswitch")
#type 1 = pupil match, 2 = pupil mismatch, 3 = no AEM

ggplot(boo2,aes(x=TIMECODE,y=pupilavg,color=factor(trialtype.pupil),fill=factor(trialtype.pupil)))+
  geom_line()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Timecourse: Pupil Change")+
  labs(x = "Time", y = "Pupil change from baseline (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  geom_ribbon(aes(ymin=pupilavg-sepupil,ymax=pupilavg+sepupil),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  guides(color=FALSE)+
  scale_color_manual(values = c("#f1af8f", "#2398a0","#acc2c7"))+
  scale_fill_manual(values = c("#f1af8f", "#2398a0","#acc2c7"),name="Trial breakdown",breaks=c("1","2","3"),labels=c("pupil match", "pupil mismatch","no AEM"))+
  theme(strip.text = element_text(size=16))+
  theme(legend.position = "bottom")+facet_wrap(~switch,labeller = as_labeller(split))

```

pupil timecourse for 3 trial types (correct, incorrect, no AEM)
```{r}
#separate for all 3 trial types
#get average pupil size
boo1 <- ddply(orig.sample5,.(subID,trialtype.aem,TIMECODE),summarise,pupil=mean(PUPIL_CORRECTED,na.rm = TRUE)) 
boo1 <- subset(boo1, TIMECODE < 4001)
#collapse across subs
boo2 <- ddply(boo1,.(trialtype.aem,TIMECODE),summarise,pupilavg=mean(pupil,na.rm = TRUE),sepupil=sd(pupil, na.rm = TRUE)/sqrt(length(pupil)))
vlines <- c(250,1750,2550)

#type 1 = pupil match, 2 = pupil mismatch, 3 = no AEM
ggplot(boo2,aes(x=TIMECODE,y=pupilavg,color=factor(trialtype.aem),fill=factor(trialtype.aem)))+
  geom_line()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Timecourse: Pupil Change")+
  labs(x = "Time", y = "Pupil change from baseline (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  geom_ribbon(aes(ymin=pupilavg-sepupil,ymax=pupilavg+sepupil),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  guides(color=FALSE)+
  scale_fill_brewer(palette="Set3",name="Sub-block",breaks=c("1","2","3"),labels=c("Correct AEM", "Incorrect AEM","No AEM"))+
  scale_color_brewer(palette="Set3")+
  theme(legend.position = "bottom")

#pre vs post
boo1 <- ddply(orig.sample5,.(subID,switch,trialtype.aem,TIMECODE),summarise,pupil=mean(PUPIL_CORRECTED,na.rm = TRUE)) #collapse across trials
boo1 <- subset(boo1, TIMECODE < 4001)
boo2 <- ddply(boo1,.(switch,trialtype.aem,TIMECODE),summarise,pupilavg=mean(pupil,na.rm = TRUE),sepupil=sd(pupil, na.rm = TRUE)/sqrt(length(pupil))) #collapse across subs
vlines <- c(250,1750,2550)
split <- c(`1` = "preswitch",`2` = "postswitch")
#type 1 = pupil match, 2 = pupil mismatch, 3 = no AEM

ggplot(boo2,aes(x=TIMECODE,y=pupilavg,color=factor(trialtype.aem),fill=factor(trialtype.aem)))+
  geom_line()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Timecourse: Pupil Change")+
  labs(x = "Time", y = "Pupil change from baseline (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  geom_ribbon(aes(ymin=pupilavg-sepupil,ymax=pupilavg+sepupil),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  guides(color=FALSE)+
  scale_fill_brewer(palette="Set3",name="Sub-block",breaks=c("1","2","3"),labels=c("Correct AEM", "Incorrect AEM","No AEM"))+
  scale_color_brewer(palette="Set3")+
  theme(legend.position = "bottom")+
  theme(strip.text = element_text(size=16))+
  facet_wrap(~switch,labeller = as_labeller(split))

```

pupil timecourse for 2 trial types (aem, no AEM)
```{r}
#get trial types
coo <- orig.sample5
coo$trialtype.aem2 <- coo$trialtype.aem
coo$trialtype.aem2[coo$trialtype.aem2==2] <- 1 #group correct and incorrect together
unique(coo$trialtype.aem2)

boo1 <- ddply(coo,.(subID,trialtype.aem2,TIMECODE),summarise,pupil=mean(PUPIL_CORRECTED,na.rm = TRUE)) 
boo1 <- subset(boo1, TIMECODE < 4001)
#collapse across subs
boo2 <- ddply(boo1,.(trialtype.aem2,TIMECODE),summarise,pupilavg=mean(pupil,na.rm = TRUE),sepupil=sd(pupil, na.rm = TRUE)/sqrt(length(pupil)))
vlines <- c(250,1750,2550)

ggplot(boo2,aes(x=TIMECODE,y=pupilavg,color=factor(trialtype.aem2),fill=factor(trialtype.aem2)))+
  geom_line()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Timecourse: Pupil Change")+
  labs(x = "Time", y = "Pupil change from baseline (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  geom_ribbon(aes(ymin=pupilavg-sepupil,ymax=pupilavg+sepupil),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  guides(color=FALSE)+
  scale_fill_brewer(palette="Set3",name="Sub-block",breaks=c("1","3"),labels=c("AEM", "No AEM"))+
  scale_color_brewer(palette="Set3")+
  theme(legend.position = "bottom")

#pre vs post
boo1 <- ddply(coo,.(subID,switch,trialtype.aem2,TIMECODE),summarise,pupil=mean(PUPIL_CORRECTED,na.rm = TRUE)) #collapse across trials
boo1 <- subset(boo1, TIMECODE < 4001)
boo2 <- ddply(boo1,.(switch,trialtype.aem2,TIMECODE),summarise,pupilavg=mean(pupil,na.rm = TRUE),sepupil=sd(pupil, na.rm = TRUE)/sqrt(length(pupil))) #collapse across subs
vlines <- c(250,1750,2550)
split <- c(`1` = "preswitch",`2` = "postswitch")
#type 1 = pupil match, 2 = pupil mismatch, 3 = no AEM

ggplot(boo2,aes(x=TIMECODE,y=pupilavg,color=factor(trialtype.aem2),fill=factor(trialtype.aem2)))+
  geom_line()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Timecourse: Pupil Change")+
  labs(x = "Time", y = "Pupil change from baseline (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  geom_ribbon(aes(ymin=pupilavg-sepupil,ymax=pupilavg+sepupil),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  guides(color=FALSE)+
  scale_fill_brewer(palette="Set3",name="Sub-block",breaks=c("1","3"),labels=c("AEM", "No AEM"))+
  scale_color_brewer(palette="Set3")+
  theme(legend.position = "bottom")+
  theme(strip.text = element_text(size=16))+
  facet_wrap(~switch,labeller = as_labeller(split))
```

pupil timecourse preswitch
color by babies who made more correct AEMs than incorrect AEMs, and babies who made more incorrect than correct, babies who made equal
plot Histogram of the proportion (proportion of correct AEMs)
```{r}
#preswitch only!!!
foo <- subset(orig.sample5, switch==1)

#for each subject, calculate % correct AEM and % incorrect AEM
doo <- ddply(foo,.(subID,trialtype.aem),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
doo1 <- subset(doo, trialtype.aem==1) #correct AEM
doo2 <- subset(doo, trialtype.aem==2) #incorrect AEM
doo.total <- ddply(doo,.(subID),summarise,totaltrials=sum(numoftrials,na.rm = TRUE))

doo.total$percentcorrect <- 0
for (j in 1:length(doo.total$subID)) { 
x <- doo.total$subID[j]  
z <- which(doo1$subID==x)
if (length(z)==0) { #if doesn't match
  doo.total$percentcorrect[j] <- 0
} else {
  doo.total$percentcorrect[j] <-doo1$numoftrials[z] / doo.total$totaltrials[j]
}} 

doo.total$percentincorrect <- 0
for (j in 1:length(doo.total$subID)) { 
x <- doo.total$subID[j]  
z <- which(doo2$subID==x)
if (length(z)==0) { #if doesn't match
  doo.total$percentincorrect[j] <- 0
} else {
  doo.total$percentincorrect[j] <-doo2$numoftrials[z] / doo.total$totaltrials[j]
}} 

#code babies 1 = more correct than incorrect AEMs, 2 = more incorrect than correct AEM, 3 = equal correct and incorrect AEM 
doo.total$subaem <- 0
for (j in 1:length(doo.total$subID)) { 
if (doo.total$percentcorrect[j] > doo.total$percentincorrect[j]) { 
  doo.total$subaem[j] <- 1
} 
if (doo.total$percentcorrect[j] < doo.total$percentincorrect[j]) { 
  doo.total$subaem[j] <- 2
} 
if (doo.total$percentcorrect[j] == doo.total$percentincorrect[j]) { #if doesn't match
  doo.total$subaem[j] <- 3
}   
} 

#histogram of % correct AEM
ggplot(doo.total,aes(doo.total$percentcorrect))+
  geom_histogram()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ggtitle("Percent correct AEM in preswitch")+
  scale_y_continuous(limits=c(0,10),breaks=seq(0,10,1))

#histogram of % incorrect AEM
ggplot(doo.total,aes(doo.total$percentincorrect))+
  geom_histogram()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ggtitle("Percent incorrect AEM in preswitch")+
  scale_y_continuous(limits=c(0,10),breaks=seq(0,10,1))

#histogram of % subaem
ggplot(doo.total,aes(doo.total$subaem))+
  geom_histogram()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

#categorize subjects
subs <- unique(doo.total$subID)
which(doo.total$subaem==2) #2  3  4  5 11 13 16 19 22 23
which(doo.total$subaem==3) #6  9 14 17 18 24 25

foo$subaem <- 1
foo$subaem[foo$subID==subs[2] | foo$subID==subs[3] |foo$subID==subs[4] |foo$subID==subs[5] |foo$subID==subs[11]| foo$subID== subs[13]| foo$subID==subs[16] | foo$subID== subs[19]| foo$subID== subs[22]| foo$subID== subs[23]] <- 2
foo$subaem[foo$subID==subs[6] | foo$subID==subs[9] | foo$subID==subs[14] |foo$subID==subs[17] |foo$subID==subs[18]| foo$subID== subs[24]| foo$subID==subs[25]] <- 3

#pupil time course preswitch
boo1 <- ddply(foo,.(subID,subaem,TIMECODE),summarise,pupilsize=mean(PUPIL_CORRECTED,na.rm = TRUE)) #collapse across subs
boo2 <- ddply(boo1,.(subaem,TIMECODE),summarise,pupilavg=mean(pupilsize,na.rm = TRUE),sepupil=sd(pupilsize, na.rm = TRUE)/sqrt(length(pupilsize))) #collapse across subs
vlines <- c(250,1750,2550)

ggplot(boo2,aes(x=TIMECODE,y=pupilavg,color=factor(subaem),fill=factor(subaem)))+
  geom_line()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Pupil timecourse preswitch")+
  labs(x = "Time", y = "Pupil change (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_ribbon(aes(ymin=pupilavg-sepupil,ymax=pupilavg+sepupil),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  scale_fill_discrete(name="Percent of correct AEMs made during preswitch",breaks=c("1","2","3"),labels=c("correct > incorrect", "incorrect > correct", "correct=incorrect"))+
  guides(color=FALSE)+
  theme(legend.position = "top")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels = scales::percent,limits=c(-.1,.1),breaks=seq(-.1,.1,.02))

#1 = more correct than incorrect AEMs, 2 = more incorrect than correct AEM, 3 = equal correct and incorrect AEM 
```

pupil timecourse postswitch
color by babies who made more correct AEMs than incorrect AEMs, and babies who made more incorrect than correct
```{r}
#postswitch only!!!
foo <- subset(orig.sample5, switch==2)

#for each subject, calculate % correct AEM and % incorrect AEM
doo <- ddply(foo,.(subID,trialtype.aem),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
doo1 <- subset(doo, trialtype.aem==1) #correct AEM
doo2 <- subset(doo, trialtype.aem==2) #incorrect AEM
doo.total <- ddply(doo,.(subID),summarise,totaltrials=sum(numoftrials,na.rm = TRUE))

doo.total$percentcorrect <- 0
for (j in 1:length(doo.total$subID)) { 
x <- doo.total$subID[j]  
z <- which(doo1$subID==x)
if (length(z)==0) { #if doesn't match
  doo.total$percentcorrect[j] <- 0
} else {
  doo.total$percentcorrect[j] <-doo1$numoftrials[z] / doo.total$totaltrials[j]
}} 

doo.total$percentincorrect <- 0
for (j in 1:length(doo.total$subID)) { 
x <- doo.total$subID[j]  
z <- which(doo2$subID==x)
if (length(z)==0) { #if doesn't match
  doo.total$percentincorrect[j] <- 0
} else {
  doo.total$percentincorrect[j] <-doo2$numoftrials[z] / doo.total$totaltrials[j]
}} 

#code babies 1 = more correct than incorrect AEMs, 2 = more incorrect than correct AEM, 3 = equal correct and incorrect AEM 
doo.total$subaem <- 0
for (j in 1:length(doo.total$subID)) { 
if (doo.total$percentcorrect[j] > doo.total$percentincorrect[j]) { 
  doo.total$subaem[j] <- 1
} 
if (doo.total$percentcorrect[j] < doo.total$percentincorrect[j]) { 
  doo.total$subaem[j] <- 2
} 
if (doo.total$percentcorrect[j] == doo.total$percentincorrect[j]) { #if doesn't match
  doo.total$subaem[j] <- 3
}   
} 

#histogram of % correct AEM
ggplot(doo.total,aes(doo.total$percentcorrect))+
  geom_histogram()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ggtitle("Percent correct AEM in postswitch")+
  scale_y_continuous(limits=c(0,20),breaks=seq(0,20,2))

#histogram of % incorrect AEM
ggplot(doo.total,aes(doo.total$percentincorrect))+
  geom_histogram()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ggtitle("Percent incorrect AEM in postswitch")+
  scale_y_continuous(limits=c(0,10),breaks=seq(0,10,1))

#histogram of % subaem
ggplot(doo.total,aes(doo.total$subaem))+
  geom_histogram()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

#categorize subjects
subs <- unique(doo.total$subID)
which(doo.total$subaem==2) #1  4  5  7  8 10 14 16 21 22 23 25
which(doo.total$subaem==3) #2  3  6 12 13 15 17 20 24

foo$subaem <- 1
foo$subaem[foo$subID==subs[1] | foo$subID==subs[4] |foo$subID==subs[5] |foo$subID==subs[7] |foo$subID==subs[8]| foo$subID== subs[10]| foo$subID==subs[14] | foo$subID== subs[16]| foo$subID== subs[21]| foo$subID== subs[22]| foo$subID== subs[23]| foo$subID== subs[25]] <- 2

foo$subaem[foo$subID==subs[2] | foo$subID==subs[3] | foo$subID==subs[6] |foo$subID==subs[12] |foo$subID==subs[13]| foo$subID== subs[15]| foo$subID==subs[17]| foo$subID==subs[20]| foo$subID==subs[24]] <- 3

#pupil time course postswitch only
boo1 <- ddply(foo,.(subID,subaem,TIMECODE),summarise,pupilsize=mean(PUPIL_CORRECTED,na.rm = TRUE)) #collapse across subs
boo2 <- ddply(boo1,.(subaem,TIMECODE),summarise,pupilavg=mean(pupilsize,na.rm = TRUE),sepupil=sd(pupilsize, na.rm = TRUE)/sqrt(length(pupilsize))) #collapse across subs
vlines <- c(250,1750,2550)

ggplot(boo2,aes(x=TIMECODE,y=pupilavg,color=factor(subaem),fill=factor(subaem)))+
  geom_line()+theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Pupil timecourse postswitch")+
  labs(x = "Time", y = "Pupil change (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_ribbon(aes(ymin=pupilavg-sepupil,ymax=pupilavg+sepupil),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  scale_fill_discrete(name="Percent of correct AEMs made during preswitch",breaks=c("1","2","3"),labels=c("correct > incorrect", "incorrect > correct", "correct=incorrect"))+
  guides(color=FALSE)+
  theme(legend.position = "top")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels = scales::percent,limits=c(-.2,.2),breaks=seq(-.2,.2,.05))

#1 = more correct than incorrect AEMs, 2 = more incorrect than correct AEM, 3 = equal correct and incorrect AEM 
```

color = correct vs incorrect AEM
x = time
y = % looking to side
facet wrap = above and below median
```{r}
#PRESWITCH
lookscode <- pupilbreakdown
#only care about 100ms timebins that has good data
e1 <- subset(lookscode, lookattarget < 9) 
#only care about preswitch
e1 <- subset(lookscode,switch==1) 

#type 1 = correct AEM to target, 2 = incorrect AEM to distractor, 3 = no AEM
#Calculate proplooking for each type of gaze (target, center, distractor)
e1$center <- 0
e1$side <- 0
e1$type2 <- e1$type
e1$type2[e1$type==2] <- 1 #1 = AEM, 3 = no AEM

e1$side[e1$lookattarget == 1] <- 1 #if lookattarget == 1, then looking at target
e1$center[e1$lookattarget == 5] <- 1 #if lookattarget == 5, then looking at center
e1$side[e1$lookattarget == 0] <- 1 #if lookattarget == 0, then looking at distractor

e1$median.aem <- 1 #below median
subs <- unique(e1$subID)  
#label in dataframe  
e1$median.aem[e1$subID==subs[1] | e1$subID==subs[4] | e1$subID==subs[5] | e1$subID==subs[8] |e1$subID==subs[10]| e1$subID==subs[12]| e1$subID==subs[13]|  e1$subID==subs[15]| e1$subID==subs[16]| e1$subID==subs[18]| e1$subID==subs[19]| e1$subID==subs[23]] <- 2

#correct vs incorrect AEM
e2 <- ddply(e1,.(subID,type,timecode,median.aem),summarise,SideProp=mean(side,na.rm = TRUE),CentProp=mean(center,na.rm = TRUE))
e2 <- subset(e2, type < 3)
#collapse across subjects
e33 <- ddply(e2,.(type,timecode,median.aem),summarise,
            looking=mean(SideProp,na.rm = TRUE),
            selooking=sd(SideProp, na.rm = TRUE)/sqrt(length(SideProp)))
split <- c(`1` = "below median",`2` = "above median")

ggplot(e33,aes(x=timecode,y=looking,color=factor(type),fill=factor(type)))+
  geom_line()+theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("correct AEM vs incorrect AEM trial (preswitch)")+
  labs(x = "Time", y = "% of looking to side")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  geom_ribbon(aes(ymin=looking-selooking,ymax=looking+selooking),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  scale_y_continuous(labels = scales::percent,limits=c(0,1),breaks=seq(0,1,0.2))+
  guides(color=FALSE)+
  theme(strip.text = element_text(size=16))+
  scale_fill_brewer(palette="Set1",name="Trial type",breaks=c("1","2"),labels=c("correct AEM", "incorrect AEM"))+
  scale_color_brewer(palette="Set1")+
  theme(legend.position = "bottom")+
  facet_wrap(~median.aem,labeller = as_labeller(split),dir="v")
```

color = correct vs incorrect AEM
x = time
y = % looking to side
facet wrap = above and below median
```{r}
#POSTSWITCH
lookscode <- pupilbreakdown
#only care about 100ms timebins that has good data
e1 <- subset(lookscode, lookattarget < 9) 
#only care about postswitch
e1 <- subset(lookscode,switch==2) 

#type 1 = correct AEM to target, 2 = incorrect AEM to distractor, 3 = no AEM
#Calculate proplooking for each type of gaze (target, center, distractor)
e1$center <- 0
e1$side <- 0
e1$type2 <- e1$type
e1$type2[e1$type==2] <- 1 #1 = AEM, 3 = no AEM

e1$side[e1$lookattarget == 1] <- 1 #if lookattarget == 1, then looking at target
e1$center[e1$lookattarget == 5] <- 1 #if lookattarget == 5, then looking at center
e1$side[e1$lookattarget == 0] <- 1 #if lookattarget == 0, then looking at distractor

e1$median.aem <- 1 #below median
subs <- unique(e1$subID)  
#label in dataframe  
e1$median.aem[e1$subID==subs[1] | e1$subID==subs[4] | e1$subID==subs[5] | e1$subID==subs[8] |e1$subID==subs[10]| e1$subID==subs[12]| e1$subID==subs[13]|  e1$subID==subs[15]| e1$subID==subs[16]| e1$subID==subs[18]| e1$subID==subs[19]| e1$subID==subs[23]] <- 2

#correct vs incorrect AEM
e2 <- ddply(e1,.(subID,type,timecode,median.aem),summarise,SideProp=mean(side,na.rm = TRUE),CentProp=mean(center,na.rm = TRUE))
e2 <- subset(e2, type < 3)
#collapse across subjects
e33 <- ddply(e2,.(type,timecode,median.aem),summarise,
            looking=mean(SideProp,na.rm = TRUE),
            selooking=sd(SideProp, na.rm = TRUE)/sqrt(length(SideProp)))
split <- c(`1` = "below median",`2` = "above median")

ggplot(e33,aes(x=timecode,y=looking,color=factor(type),fill=factor(type)))+
  geom_line()+theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("correct AEM vs incorrect AEM trial (postswitch)")+
  labs(x = "Time", y = "% of looking to side")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  geom_ribbon(aes(ymin=looking-selooking,ymax=looking+selooking),alpha=0.4)+
  geom_vline(xintercept = vlines)+
  scale_x_continuous(limits=c(0,4000),breaks=seq(0,4000,500), expand = c(0, 0))+
  scale_y_continuous(labels = scales::percent,limits=c(0,1),breaks=seq(0,1,0.2))+
  guides(color=FALSE)+
  theme(strip.text = element_text(size=16))+
  scale_fill_brewer(palette="Set1",name="Trial type",breaks=c("1","2"),labels=c("correct AEM", "incorrect AEM"))+
  scale_color_brewer(palette="Set1")+
  theme(legend.position = "bottom")+
  facet_wrap(~median.aem,labeller = as_labeller(split),dir="v")
```

X axis = % correct aem during pre-switch
Y axis = % incorrect aem during post-switch
for every subject

```{r}
#correct aem for preswitch only!!!
doo <- ddply(orig.sample5,.(subID,trialtype.aem,switch),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
doo1 <- subset(doo, switch==1) #preswitch
doo2 <- subset(doo1, trialtype.aem==1) #correct AEMs in pre
doo.total <- ddply(doo1,.(subID),summarise,totalpre=sum(numoftrials,na.rm = TRUE)) #total trials in pre

doo.total$percentcorrect <- 0
for (j in 1:length(doo.total$subID)) { 
x <- doo.total$subID[j]  
z <- which(doo2$subID==x)
if (length(z)==0) { #if doesn't match
  doo.total$percentcorrect[j] <- 0
} else {
  doo.total$percentcorrect[j] <-doo2$numoftrials[z] / doo.total$totalpre[j]
}} 

#incorrect aem for postswitch only!!!
coo <- ddply(orig.sample5,.(subID,trialtype.aem,switch),summarise,numoftrials=length(unique(TRIAL_INDEX,na.rm = TRUE)))
coo1 <- subset(coo, switch==2) #postswitch
coo2 <- subset(coo1, trialtype.aem==1) #incorrect AEMs in post
coo.total <- ddply(coo1,.(subID),summarise,totalpost=sum(numoftrials,na.rm = TRUE)) #total trials in post

coo.total$percentincorrect <- 0
for (j in 1:length(coo.total$subID)) { 
x <- coo.total$subID[j]  
z <- which(coo2$subID==x)
if (length(z)==0) { #if doesn't match
  coo.total$percentincorrect[j] <- 0
} else {
  coo.total$percentincorrect[j] <-coo2$numoftrials[z] / coo.total$totalpost[j]
}} 

#combine
doo.total$percentincorrect <- coo.total$percentincorrect

ggplot(doo.total,aes(x=percentcorrect,y=percentincorrect))+
  geom_point(size=5)+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  labs(x = "% of correct AEMs during pre-switch", y = "% of incorrect AEMs during post-switch")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  guides(color=FALSE)+guides(fill=FALSE)+
  stat_smooth(method=lm)+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels = scales::percent,limits=c(0,.3),breaks=seq(0,.3,.1))+
  scale_x_continuous(labels = scales::percent,limits=c(0,.4),breaks=seq(0,.4,.1))

```

for correct and incorrect AEM, do % of trials per baby for pre vs post
REDO THIS
```{r}
#total num of trials for pre and post
e1 <- ddply(aembreakdown,.(subID,switch),summarise,totaltrials=length(unique(trialnum)))

#type 1 = correct AEM to target, 2 = incorrect AEM to distractor, 3 = no AEM
#correct AEM
e2 <- subset(aembreakdown, type ==1)
e22 <- ddply(e2,.(subID,switch),summarise,totaltrials=length(unique(trialnum)))

newData1 <- data.frame(subID = "1", switch = "2", totaltrials = "0")
newData2 <- data.frame(subID = "2", switch = "1", totaltrials = "0")
newData3 <- data.frame(subID = "2", switch = "2", totaltrials = "0")
newData4 <- data.frame(subID = "5", switch = "1", totaltrials = "0")
newData5 <- data.frame(subID = "6", switch = "2", totaltrials = "0")
newData6 <- data.frame(subID = "7", switch = "2", totaltrials = "0")
newData7 <- data.frame(subID = "8", switch = "1", totaltrials = "0")
newData8 <- data.frame(subID = "8", switch = "2", totaltrials = "0")
newData9 <- data.frame(subID = "9", switch = "2", totaltrials = "0")
newData10 <- data.frame(subID = "10", switch = "2", totaltrials = "0")
newData11 <- data.frame(subID = "11", switch = "1", totaltrials = "0")
newData12 <- data.frame(subID = "12", switch = "2", totaltrials = "0")
newData13 <- data.frame(subID = "13", switch = "1", totaltrials = "0")
newData14 <- data.frame(subID = "14", switch = "2", totaltrials = "0")
newData15 <- data.frame(subID = "17", switch = "1", totaltrials = "0")
newData16 <- data.frame(subID = "17", switch = "2", totaltrials = "0")
newData17 <- data.frame(subID = "21", switch = "1", totaltrials = "0")
newData18 <- data.frame(subID = "21", switch = "2", totaltrials = "0")
newData19 <- data.frame(subID = "25", switch = "2", totaltrials = "0")
newData20 <- data.frame(subID = "26", switch = "2", totaltrials = "0")
newData21 <- data.frame(subID = "28", switch = "2", totaltrials = "0")
newData22 <- data.frame(subID = "31", switch = "2", totaltrials = "0")
newData23 <- data.frame(subID = "33", switch = "2", totaltrials = "0")

e22 <- rbind( e22[1,], newData1, e22[2:29,] )
e22 <- rbind( e22[1:2,], newData2, e22[3:30,] )
e22 <- rbind( e22[1:3,], newData3, e22[4:31,] )
e22 <- rbind( e22[1:4,], newData4, e22[5:32,] )
e22 <- rbind( e22[1:7,], newData5, e22[8:33,] )
e22 <- rbind( e22[1:9,], newData6, e22[10:34,] )
e22 <- rbind( e22[1:10,], newData7, e22[11:35,] )
e22 <- rbind( e22[1:11,], newData8, e22[12:36,] )
e22 <- rbind( e22[1:13,], newData9, e22[14:37,] )
e22 <- rbind( e22[1:15,], newData10, e22[16:38,] )
e22 <- rbind( e22[1:16,], newData11, e22[17:39,] )
e22 <- rbind( e22[1:19,], newData12, e22[20:40,] )
e22 <- rbind( e22[1:20,], newData13, e22[21:41,] )
e22 <- rbind( e22[1:23,], newData14, e22[24:42,] )
e22 <- rbind( e22[1:26,], newData15, e22[27:43,] )
e22 <- rbind( e22[1:27,], newData16, e22[28:44,] )
e22 <- rbind( e22[1:32,], newData17, e22[33:45,] )
e22 <- rbind( e22[1:33,], newData18, e22[34:46,] )
e22 <- rbind( e22[1:39,], newData19, e22[40:47,] )
e22 <- rbind( e22[1:41,], newData20, e22[42:48,] )
e22 <- rbind( e22[1:43,], newData21, e22[44:49,] )
e22 <- rbind( e22[1:45,], newData22, e22[46:50,] )
e22 <- rbind( e22[1:49,], newData23, e22[50:51,] )
e22$totaltrials <- as.numeric(as.character(e22$totaltrials))
e22$subID <- as.numeric(as.character(e22$subID))
e22$switch <- as.numeric(as.character(e22$switch))
e22$percent <- e22$totaltrials / e1$totaltrials

e222 <- ddply(e22,.(switch),summarise,trialavg=mean(percent,na.rm = TRUE),setrials=sd(percent, na.rm = TRUE)/sqrt(length(percent)))
e222$group <- 3

#incorrect AEM
e3 <- subset(aembreakdown, type ==2)
e33 <- ddply(e3,.(subID,switch),summarise,totaltrials=length(unique(trialnum)))

newData1 <- data.frame(subID = "2", switch = "2", totaltrials = "0")
newData2 <- data.frame(subID = "8", switch = "1", totaltrials = "0")
newData3 <- data.frame(subID = "8", switch = "2", totaltrials = "0")
newData4 <- data.frame(subID = "9", switch = "1", totaltrials = "0")
newData5 <- data.frame(subID = "11", switch = "1", totaltrials = "0")
newData6 <- data.frame(subID = "11", switch = "2", totaltrials = "0")
newData7 <- data.frame(subID = "13", switch = "2", totaltrials = "0")
newData8 <- data.frame(subID = "14", switch = "1", totaltrials = "0")
newData9 <- data.frame(subID = "14", switch = "2", totaltrials = "0")
newData10 <- data.frame(subID = "17", switch = "1", totaltrials = "0")
newData11 <- data.frame(subID = "18", switch = "1", totaltrials = "0")
newData12 <- data.frame(subID = "18", switch = "2", totaltrials = "0")
newData13 <- data.frame(subID = "21", switch = "1", totaltrials = "0")
newData14 <- data.frame(subID = "21", switch = "2", totaltrials = "0")
newData15 <- data.frame(subID = "24", switch = "2", totaltrials = "0")
newData16 <- data.frame(subID = "25", switch = "1", totaltrials = "0")
newData17 <- data.frame(subID = "25", switch = "2", totaltrials = "0")
newData18 <- data.frame(subID = "26", switch = "1", totaltrials = "0")
newData19 <- data.frame(subID = "34", switch = "1", totaltrials = "0")
newData20 <- data.frame(subID = "34", switch = "2", totaltrials = "0")

e33 <- rbind( e33[1:3,], newData1, e33[4:32,] )
e33 <- rbind( e33[1:10,], newData2, e33[11:33,] )
e33 <- rbind( e33[1:11,], newData3, e33[12:34,] )
e33 <- rbind( e33[1:12,], newData4, e33[13:35,] )
e33 <- rbind( e33[1:16,], newData5, e33[17:36,] )
e33 <- rbind( e33[1:17,], newData6, e33[18:37,] )
e33 <- rbind( e33[1:21,], newData7, e33[22:38,] )
e33 <- rbind( e33[1:22,], newData8, e33[23:39,] )
e33 <- rbind( e33[1:23,], newData9, e33[24:40,] )
e33 <- rbind( e33[1:26,], newData10, e33[27:41,] )
e33 <- rbind( e33[1:28,], newData11, e33[29:42,] )
e33 <- rbind( e33[1:29,], newData12, e33[30:43,] )
e33 <- rbind( e33[1:32,], newData13, e33[33:44,] )
e33 <- rbind( e33[1:33,], newData14, e33[34:45,] )
e33 <- rbind( e33[1:37,], newData15, e33[38:46,] )
e33 <- rbind( e33[1:38,], newData16, e33[39:47,] )
e33 <- rbind( e33[1:39,], newData17, e33[40:48,] )
e33 <- rbind( e33[1:40,], newData18, e33[41:49,] )
e33 <- rbind( e33[1:50,], newData19)
e33 <- rbind( e33[1:51,], newData20)

e33$totaltrials <- as.numeric(as.character(e33$totaltrials))
e33$subID <- as.numeric(as.character(e33$subID))
e33$switch <- as.numeric(as.character(e33$switch))
e33$percent <- e33$totaltrials / e1$totaltrials

e333 <- ddply(e33,.(switch),summarise,trialavg=mean(percent,na.rm = TRUE),setrials=sd(percent, na.rm = TRUE)/sqrt(length(percent)))
e333$group <- 2
dodge <- position_dodge(width=0.9)
limits <- aes(ymax = trialavg + setrials, ymin=trialavg - setrials)

efinal <- rbind(e222,e333)
ggplot(efinal,aes(x=factor(switch),y=trialavg,fill=factor(group),color=factor(group)))+
  geom_bar(stat="identity",position=dodge)+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  labs(y = "% of trials")+
  theme(plot.title = element_text(face="bold", size=16, hjust=0))+
  theme(axis.title = element_text(face="bold", size=16),axis.title.x=element_blank())+ 
  theme(axis.text.x  = element_text(size=16),axis.text.y  = element_text(size=16))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  scale_x_discrete(breaks=c("1","2"),labels=c("pre-switch", "post-switch"))+
  theme(strip.text = element_text(size=16))+
  guides(color=FALSE)+
  scale_color_manual(values = c("#fffcb7", "#bebad9"))+
  scale_fill_manual(values = c("#fffcb7", "#bebad9"),name="Trial breakdown",breaks=c("2","3"),labels=c("incorrect AEMs","correct AEMs"))+
  scale_y_continuous(labels=percent,limits=c(0,.14),breaks=seq(0,.14,.02))+
  theme(legend.position = "top")+
  geom_errorbar(limits, width=0.25,position = position_dodge(0.9),color="black")

#STATS: logistic regression
#code every trial: 1 or 0 for incorrect or correct AEM
zoo <- ddply(orig.sample5,.(subID,switch,TRIAL_INDEX,NEWTRIALNUM),summarise,trialtype=unique(trialtype,na.rm = TRUE))
zoo <- subset(zoo, trialtype < 3)
zoo$trialtype[zoo$trialtype==2] <- 0 #relabel incorrect AEM as 0
zoo$switch[zoo$switch==1] <- 0 #relabelling it for coloring
zoo$switch[zoo$switch==2] <- 1 #relabelling it for coloring

zoo <- within(zoo, {
  subID   <- factor(subID)
  switch <- factor(switch)
  trialtype <- factor(trialtype)
})

model <- glm(trialtype ~ switch,family=binomial(link='logit'),data=zoo)
summary(model)

```

